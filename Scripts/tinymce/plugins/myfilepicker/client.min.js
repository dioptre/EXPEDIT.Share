(function(){



window.renderFunction['tiny-img'] = function (selected) {

    var json = selected.data('json');
    var id = ''
    if (json.width != 0) {
        id = 'tiny-img-img' + json.refid;
        var img = $('<img>').attr({
            id: id,
            src: "/share/preview/" + json.refid + ((typeof json.width === 'undefined' || json.width == null || json.width < 1 || json.width > 600) ? "" : "?width=" + json.width),
            width: json.width
        })


        selected.append(img);
        selected.append($('<br/>'));
    }

    selected.append($('<a>').attr({
        href: "/share/file/" + json.refid
    }).html(json.name));

    // Zoomerang.listen('#' + id);

}

window.renderFunction['tiny-img-editor'] = function (e) {
    if (typeof e !== 'undefined' && typeof e.target !== 'undefined' && typeof e.target.editorContainer !== 'undefined' && e.target.editorContainer) {
        var currentDocument = $(tinymce.activeEditor.contentDocument);
        currentDocument.find('*').andSelf().filter('.tiny').each(function (i, selected) {
            var json = $(selected).data('json');

            if ($(selected).attr('type') === 'tiny-img') {
                //tinymce.activeEditor.contentDocument.getElementById(selected.id).onclick = function (e) {
                $(selected).click(function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    var children = currentDocument.find('.tiny-popover');
                    var found = (currentDocument.find('#pop-' + selected.id).length > 0);
                    if (children.length > 0) {
                        children.remove();
                    }
                    if (!found) {
                        var html = '';
                        html += '<div id="pop-' + selected.id + '" class="tiny-popover disable-user-select fade bottom in" role="tooltip" style="bottom: 0px; left: 0px; top: initial; display: block;"><div class="arrow"></div>';
                        html += '<div class="popover-content">';
                        html += '<div class="btn-group">';
                        html += '<button id="sml-' + selected.id + '" type="button" class="btn btn-default tiny-popover-shrink"><span class="icon icon-picture"></span></button>';
                        html += '<button id="lge-' + selected.id + '" type="button" class="btn btn-default tiny-popover-grow"><span class="icon icon-picture icon-large"></span></button>';
                        html += '<button id="nil-' + selected.id + '" type="button" class="btn btn-default tiny-popover-nil"><span class="icon icon-ban-circle"></span></button>';
                        html += '</div>';
                        html += '</div></div>';
                        // extra click handlers necessary here to update the json on selected.
                        $(e.currentTarget).closest('div[id="' + selected.id + '"]').after($(html)[0]); //TODO BUG: need to append after id...
                        $(e.currentTarget).parent().find('#sml-' + selected.id).mouseup(function (ev) {
                            var id = ev.currentTarget.id.substr(4);
                            var parent = $(e.currentTarget).closest('div[id="' + id + '"]');
                            var json = parent.data().json;
                            json.width = 300;
                            parent.attr({ 'data-json': JSON.stringify(json) });
                            window.cleanFunctions(parent);
                            window.renderFunction['tiny-img'](parent);
                        });
                        $(e.currentTarget).parent().find('#lge-' + selected.id).mouseup(function (ev) {
                            var id = ev.currentTarget.id.substr(4);
                            var parent = $(e.currentTarget).closest('div[id="' + id + '"]');
                            var json = parent.data().json;
                            json.width = 600;
                            parent.attr({ 'data-json': JSON.stringify(json) });
                            window.cleanFunctions(parent);
                            window.renderFunction['tiny-img'](parent);
                        });
                        $(e.currentTarget).parent().find('#nil-' + selected.id).mouseup(function (ev) {
                            var id = ev.currentTarget.id.substr(4);
                            var parent = $(e.currentTarget).closest('div[id="' + id + '"]');
                            var json = parent.data().json;
                            json.width = 0;
                            parent.attr({ 'data-json': JSON.stringify(json) });
                            window.cleanFunctions(parent);
                            window.renderFunction['tiny-img'](parent);
                        });
                    }
                });
            }

        });
    }
}


})()